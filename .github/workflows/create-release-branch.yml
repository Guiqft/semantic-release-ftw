name: Create Release PR

on:
    workflow_dispatch:
        inputs:
            releaseType:
                description: "Release Type"
                required: true
                default: "rc"
                type: choice
                options:
                    - rc
                    - latest

permissions:
    pull-requests: write
    contents: write

jobs:
    get-next-version:
        runs-on: ubuntu-latest
        steps:
            - name: Set Branch Name
              id: set-brach-name
              run: |
                  if [ "${{ github.event.inputs.releaseType }}" == "rc" ]; then
                      echo "BRANCH_NAME=homolog" >> $GITHUB_OUTPUT
                  elif [ "${{ github.event.inputs.releaseType }}" == "latest" ]; then
                      echo "BRANCH_NAME=main" >> $GITHUB_OUTPUT
                  fi

            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ steps.set-brach-name.outputs.BRANCH_NAME }}

            - name: Rebase
              run: |
                  git config user.name github-actions
                  git config user.email github-actions@github.com

                  git checkout origin/${GITHUB_REF##*/}
                  git pull origin ${GITHUB_REF##*/}
                  git rebase origin/${{ steps.set-brach-name.outputs.BRANCH_NAME }} -X ours --committer-date-is-author-date

            - uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun i

            - run: GITHUB_REF=${{ steps.set-brach-name.outputs.BRANCH_NAME }} bunx semantic-release --dry-run --no-ci
              id: get-next-version
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        outputs:
            needs-release: ${{ steps.get-next-version.outputs.new-release-published }}
            new-release-version: ${{ steps.get-next-version.outputs.new-release-version }}
            release-branch-name: ${{ steps.set-brach-name.outputs.BRANCH_NAME }}

    create-pr:
        runs-on: ubuntu-latest
        needs: get-next-version
        if: needs.get-next-version.outputs.needs-release == 'true'
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0
                  ref: ${{ needs.get-next-version.outputs.release-branch-name }}

            - name: Set Release Branch
              id: set-release-branch
              run: |
                  RAW_VERSION=$(echo ${{ needs.get-next-version.outputs.new-release-version }} | sed 's/-.*$//')
                  echo "RELEASE_BRANCH=release/v$RAW_VERSION" >> $GITHUB_OUTPUT

            - name: Create Release Branch
              run: |
                  RELEASE_BRANCH=${{ steps.set-release-branch.outputs.RELEASE_BRANCH }}
                  if git show-ref --quiet refs/heads/$RELEASE_BRANCH; then
                    echo "Release branch $RELEASE_BRANCH already exists. Skipping branch creation."
                  else
                    git config user.name github-actions
                    git config user.email github-actions@github.com

                    git checkout origin/${GITHUB_REF##*/}
                    git pull origin ${GITHUB_REF##*/}
                    git rebase origin/${{ needs.get-next-version.outputs.release-branch-name }} -X ours --committer-date-is-author-date

                    git checkout -b $RELEASE_BRANCH
                    git push origin $RELEASE_BRANCH -f
                  fi

            - name: Create Pull Request
              run: |
                  gh pr create \
                    --base ${{ needs.get-next-version.outputs.release-branch-name }} \
                    --head ${{ steps.set-release-branch.outputs.RELEASE_BRANCH }} \
                    --title 'chore: release  v${{ needs.get-next-version.outputs.new-release-version }}' \
                    --body 'This PR was automatically created by Github Actions'
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
